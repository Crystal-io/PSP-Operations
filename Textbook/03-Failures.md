# 03. Failures: технические сбои и операционная стабильность

## Цель главы

Эта глава посвящена **failures** — техническим сбоям и нестабильностям, из-за которых платежи
не доходят до финального результата, даже если бизнес-логика и банки не против операции.

После прочтения ты должен:
- чётко отличать failures от declines;
- понимать основные типы технических сбоев в платежах;
- уметь определять, где именно произошёл сбой;
- понимать влияние failures на бизнес и метрики;
- мыслить категориями stability, reliability и recovery.

---

## 1. Что такое failure (и чем он отличается от decline)

**Failure** — это ситуация, когда платеж:
- не завершился корректно;
- из-за технической ошибки, сбоя или нестабильности;
- без однозначного бизнес-ответа «approved» или «declined».

Ключевое отличие:
- **decline** — это осознанный отказ;
- **failure** — это невозможность корректно завершить процесс.

Примеры failures:
- timeout запроса;
- internal server error;
- потерянный webhook;
- расхождение статусов между системами.

---

## 2. Почему failures — критическая зона для PSP Ops

Failures опасны тем, что:
- напрямую портят пользовательский опыт;
- создают операционный хаос (pending, ручные проверки);
- нагружают support и finance;
- часто **маскируются** под declines или «просто баги».

Для бизнеса failure =:
- потерянный или «зависший» депозит;
- недовольный клиент;
- риск double charge или missed payout.

PSP Ops отвечает за:
> минимизацию impact и быстрое восстановление стабильности.

---

## 3. Основные типы failures в платежных системах

### 3.1. Network timeouts

**Описание:**
- запрос ушёл, но ответ не был получен вовремя;
- система не знает, был ли платеж обработан.

Причины:
- проблемы сети;
- высокая латентность PSP;
- перегрузка downstream-сервисов.

Проявление:
- рост timeout rate;
- увеличение pending платежей;
- повторные попытки клиента.

Роль Ops:
- анализ latency (p95 / p99);
- проверка retry policy;
- работа с idempotency;
- fallback на альтернативного PSP.

---

### 3.2. Internal server errors (5xx)

**Описание:**
- ошибка на стороне PSP или gateway;
- бизнес-логика не была выполнена.

Причины:
- баги;
- деплой;
- перегрузка;
- некорректные конфигурации.

Проявление:
- резкий рост ошибок;
- корреляция с релизами;
- проблемы по всем GEO/методам.

Роль Ops:
- быстрое выявление correlation с изменениями;
- rollback / mitigation;
- эскалация провайдеру с примерами запросов.

---

### 3.3. Webhook / callback failures

**Описание:**
- PSP отправил статус, но система его не получила или не обработала.

Причины:
- недоступный endpoint;
- проблемы с подписью;
- дубликаты;
- неверная обработка асинхронных событий.

Проявление:
- расхождение статусов;
- completed у PSP, pending у продукта;
- ручные reconciliation.

Роль Ops:
- контроль delivery rate webhooks;
- idempotent обработка;
- повторная синхронизация статусов.

---

### 3.4. Duplicate & retry issues

**Описание:**
- повторные попытки платежа без корректной защиты.

Причины:
- aggressive retry policy;
- client-side retries;
- отсутствие idempotency keys.

Проявление:
- двойные списания;
- сложные возвраты;
- рост chargebacks.

Роль Ops:
- контроль retry logic;
- работа с product и tech;
- обучение PSP best practices.

---

### 3.5. Status inconsistency & reconciliation failures

**Описание:**
- разные системы считают платеж в разном состоянии.

Причины:
- race conditions;
- потерянные события;
- несогласованная state machine.

Проявление:
- finance и продукт видят разные цифры;
- ручные корректировки;
- потеря доверия к данным.

Роль Ops:
- запуск reconciliation процессов;
- выравнивание источника истины;
- контроль SLA по расхождениям.

---

## 4. Failures и метрики

Failures редко проявляются одной метрикой.

Типичные сигналы:
- рост timeouts;
- увеличение pending;
- падение conversion без роста declines;
- рост обращений в support;
- расхождение между PSP reports и internal data.

Важно:
> failure — это не «одна ошибка», а **паттерн симптомов**.

---

## 5. Lifecycle failure-инцидента

Типовой сценарий:

1. Детекция:
   - алерт или жалобы;
   - метрики выходят за baseline.

2. Triage:
   - scope (PSP / GEO / method);
   - тип failure;
   - severity.

3. Mitigation:
   - fallback PSP;
   - отключение метода;
   - rollback изменений.

4. Communication:
   - внутренние команды;
   - PSP;
   - иногда — customer support.

5. Resolution:
   - подтверждение стабильности;
   - восстановление нормальных метрик.

6. Postmortem:
   - root cause;
   - preventive actions.

---

## 6. Типичные ошибки в работе с failures

- treating failures как единичные баги;
- отсутствие чётких SLA и playbook;
- агрессивные retries без idempotency;
- плохая коммуникация с PSP;
- отсутствие postmortem.

PSP Ops должен:
> думать не «как починить сейчас», а «как не допустить снова».

---

## 7. Key takeaways

- Failure — это технический сбой, а не отказ.
- Failures опаснее declines с точки зрения стабильности.
- Большинство failures повторяются по шаблонам.
- Ops работает с reliability, recovery и impact.
- Умение управлять failures — признак зрелой платежной операции.

---

## 8. Как использовать эту главу

1. Прочитать и осмыслить типы failures.
2. Вспомнить реальные кейсы из своего опыта.
3. Связать failures с метриками и инцидентами.
4. Использовать `Quick/ops/*` как практический тренажёр.
5. На интервью говорить о failures через lifecycle инцидента.

Эта глава формирует мышление Operations-специалиста.
